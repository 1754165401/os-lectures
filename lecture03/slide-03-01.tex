\input{../preamble}

%----------------------------------------------------------------------------------------
%	TITLE PAGE
%----------------------------------------------------------------------------------------

\title[第3讲]{第3讲 中断、异常和系统调用} % The short title appears at the bottom of every slide, the full title is only on the title page
\subtitle{第一节：中断的概念}
\author{向勇、陈渝} % Your name
\institute[清华大学] % Your institution as it will appear on the bottom of every slide, may be shorthand to save space
{
清华大学计算机系 \\ % Your institution for the title page
\medskip
\textit{xyong,yuchen@tsinghua.edu.cn} % Your email address
}
\date{\today} % Date, can be changed to a custom date

\begin{document}

\begin{frame}
\titlepage % Print the title page as the first slide
\end{frame}

%----------------------------------------------------------------------------------------
\begin{frame}
\frametitle{提纲} % Table of contents slide, comment this block out to remove it
\tableofcontents % Throughout your presentation, if you choose to use \section{} and \subsection{} commands, these will automatically be printed on this slide as an overview of your presentation
\end{frame}

%----------------------------------------------------------------------------------------
%	PRESENTATION SLIDES
%----------------------------------------------------------------------------------------
%------------------------------------------------
\section{第一节：中断的概念}% Sections can be created in order to organize your presentation into discrete blocks, all sections and subsections are automatically printed in the table of contents as an overview of the talk
%------------------------------------------------

\subsection{背景} % A subsection can be created just before a set of slides with a common theme to further break down your presentation into chunks
%------------------------------------------------

\begin{frame}[plain,t]
	
	\frametitle{背景}
	
	
	\begin{block}{系统调用(system call)}
		应用程序\textbf{主动}向操作系统发出的服务请求
	\end{block} 
	
	
	\begin{figure}
		\centering
		\includegraphics[width=0.7\linewidth]{os-position}
		%\caption{操作系统}
	\end{figure}
	
\end{frame}
%------------------------------------------------

\begin{frame}[plain,t]
	
	\frametitle{背景}
	
	
	\begin{block}{异常(exception)}
		非法指令或者其他原因导致\textbf{当前指令执行失败},
		(如：内存出错)后的处理请求
	\end{block} 
	
	
	\begin{figure}
		\centering
		\includegraphics[width=0.7\linewidth]{os-position}
		%\caption{操作系统}
	\end{figure}
	
\end{frame}
%------------------------------------------------

\begin{frame}[plain,t]
	
	\frametitle{背景}
	
	
	\begin{block}{中断(hardware interrupt)}
		来自硬件设备（外设, device）的处理请求
	\end{block} 
	
	
	\begin{figure}
		\centering
		\includegraphics[width=0.7\linewidth]{os-position}
		%\caption{操作系统}
	\end{figure}
	
\end{frame}
%------------------------------------------------

\begin{frame}[plain]
	\frametitle{背景}
	
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-position}
		\end{column}
		
	\begin{column}{0.6\textwidth}
		
    \begin{itemize}
		\item 为什么需要中断、异常和系统调用 \pause
		\begin{itemize}
			\item OS内核是被信任的第三方
			\item OS内核可以执行特权指令，管理硬件
			\item OS内核提供了各种Service
		\end{itemize}   \pause
		\item 中断希望解决的问题
		\begin{itemize}
			\item 当外设连接计算机时，会出现什么现象?
		\end{itemize}  \pause
		\item 异常希望解决的问题
		\begin{itemize}
			\item 当应用程序处理意想不到的行为时，会出现什么现象?
		\end{itemize} \pause
		\item 系统调用希望解决的问题
		\begin{itemize}
			\item 用户应用程序是如何得到系统服务?
%			\item 系统调用和功能调用的不同之处是什么?
		\end{itemize}
	\end{itemize}		
	
	\end{column}
		
	\end{columns}
	
\end{frame}

%------------------------------------------------

\begin{frame}[plain]
	\frametitle{背景}
	
	\begin{columns}
		
		\begin{column}{0.5\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\begin{itemize}
				\item 源头 
				\begin{itemize}
					\item 中断：外设 \pause
					\item 异常：应用程序意想不到的行为 \pause
					\item 系统调用：应用程序请求OS服务 \pause
				\end{itemize}  
				\item 响应方式  \pause
				\begin{itemize}
					\item 中断：异步
					\item 异常：同步
					\item 系统调用：异步或同步
				\end{itemize}  \pause
				\item 处理机制
				\begin{itemize} \pause
					\item 中断：持续，对应用程序透明 \pause
					\item 异常：杀死或者重新执行 \pause
					\item 系统调用：等待和持续
				\end{itemize}

			\end{itemize}		
			
		\end{column}
		
	\end{columns}
	
\end{frame}
%------------------------------------------------
\begin{frame}
	\frametitle{硬件的支持}
%	\framesubtitle{xxxx}
	\begin{columns}
	
	\begin{column}{0.5\textwidth}
		\centering
		\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
	\end{column}
	
	\begin{column}{0.5\textwidth}
				
		\centering
		\includegraphics[width=1.0\linewidth]{ecall}	
			
		\begin{itemize}
		\item 在 RISC-V中,ecall 指令用于向运行时环境发出请求,例如\underline{系统调用}
		\end{itemize}		
	
	\end{column}
	
\end{columns}

\end{frame}


%------------------------------------------------
\begin{frame}
	\frametitle{硬件的支持}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.5\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
			\includegraphics[width=1.0\linewidth]{ebreak}	
			
			\begin{itemize}
				\item 在 RISC-V中,ebreak指令或其他错误可向运行时环境发出异常请求
			\end{itemize}		
			
		\end{column}
		
	\end{columns}
	
\end{frame}


%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{硬件的支持}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.5\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
%			\centering
%			\includegraphics[width=1.0\linewidth]{ebreak}	
			异常类型
			\begin{itemize}
				\item 访问错误异常:当物理内存的地址不支持访问类型时发生 \pause
				\item 断点异常:在执行 ebreak 指令,或地址/数据与调试触发器匹配时发生 \pause
				\item 环境调用异常:执行 ecall 指令时发生 \pause
				\item 非法指令异常:在译码阶段发现无效操作码时发生 \pause
				\item 非对齐地址异常:在有效地址不能被访问大小整除时发生 \pause
				\item 页错误异常:访问未被映射的页或访问权限不足
				
			\end{itemize}		
			
		\end{column}
		
	\end{columns}
	
\end{frame}



%------------------------------------------------
\begin{frame}[plain]
	\frametitle{硬件的支持}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
		    \end{itemize}
		\end{column}
		
		\begin{column}{0.6\textwidth}
			
			\centering
			\includegraphics[width=1.0\linewidth]{fu540}	
			
%			\begin{itemize}
%				\item 在 RISC-V中,ebreak指令或其他错误可向运行时环境发出异常请求
%			\end{itemize}		
			
		\end{column}
		
	\end{columns}
	
\end{frame}


%------------------------------------------------
\begin{frame}[plain]
	\frametitle{硬件的支持}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.6\textwidth}
			
			\centering
			\includegraphics[width=1.0\linewidth]{fu540-intr-arch}	
			
			%			\begin{itemize}
			%				\item 在 RISC-V中,ebreak指令或其他错误可向运行时环境发出异常请求
			%			\end{itemize}		
			
		\end{column}
		
	\end{columns}
	
\end{frame}


%------------------------------------------------
\begin{frame}[plain]
	\frametitle{硬件的支持}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.45\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
%			\centering
			\includegraphics[width=0.6\linewidth]{fu540-intr-arch}	
			
			三种标准的中断源:
			\begin{itemize}
				\item 软件中断通过向内存映射寄存器中存数来触发，如 IPI \pause
				\item 时钟中断,如 stimecmp > stime  \pause
				\item 由平台级中断控制器引发外部中断
			\end{itemize}		
			
		\end{column}
		
	\end{columns}
	
\end{frame}



%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.45\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			%			\centering
			\includegraphics[width=0.6\linewidth]{fu540-intr-arch}	
			
			建立中断机制
			\begin{itemize}
				\item 让CPU能响应中断 \pause
					\begin{itemize}
						\item sstatus:保存全局中断使能位	 \pause
						\item sie:指出CPU目前能处理或忽略的中断 \pause
					\end{itemize}		
			\end{itemize}		
			
		\end{column}他
		
	\end{columns}
	
\end{frame}

%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.45\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			%			\centering
%			\includegraphics[width=0.6\linewidth]{fu540-intr-arch}	
			\centering
			\LARGE 建立中断机制 \pause
			
			\Large
			\begin{itemize}
				\item 建立中断服务例程	 \pause
				\item 让CPU能响应中断 \pause
				\item 响应并处理中断 \pause
				\item 保存/恢复现场 
			\end{itemize}		
			
		\end{column}
		
	\end{columns}
	
\end{frame}


%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--建立中断服务例程}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.45\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			%			\centering
			\includegraphics[width=1.\linewidth]{fu540-intr-arch}	
%			\centering
%			\LARGE 建立中断机制 \pause
%			
%			\Large
%			\begin{itemize}
%				\item 建立中断服务例程	 \pause
%				\item 让CPU能响应中断 \pause
%				\item 响应并处理中断 \pause
%				\item 保存/恢复现场 
%			\end{itemize}		
			
		\end{column}
		
	\end{columns}
	
\end{frame}



%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--建立中断服务例程}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.45\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
			
			\includegraphics[width=.3\linewidth]{timer}
			%show rcore tutorial	
			
		\end{column}
		
	\end{columns}
	
\end{frame}


%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--建立中断服务例程}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.45\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
			
			\includegraphics[width=.3\linewidth]{timer}
			%show rcore tutorial	
			
			\begin{itemize} \small 
				\item 初始化：设置时钟中断触发次数  \pause
				\item 初始化：设置 sie 的 TI 使能 STIE 位  \pause
				\item 服务例程：调用 OpenSBI 提供的接口设置下次时钟中断触发时间
			\end{itemize}
		    
		\end{column}
		
	\end{columns}
	
\end{frame}


%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--建立中断服务例程}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.6\textwidth}
			
			\centering
			%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
			
			\includegraphics[width=1.\linewidth]{showmethecode}
			%show rcore tutorial	
			
%			\begin{itemize} \small
%				\item 初始化：设置时钟中断触发次数
%				\item 初始化：设置 sie 的 TI 使能 STIE 位
%				\item 服务例程：调用 OpenSBI 提供的接口设置下次时钟中断触发时间
%			\end{itemize} \pause
%			
		\end{column}
		
	\end{columns}
	
\end{frame}


%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--让CPU能响应中断}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
			
			\includegraphics[width=.3\linewidth]{timer}
			%show rcore tutorial	
			
			\begin{itemize} \small 
				\item 初始化：设置 sie 的 TI 使能 STIE 位 \pause
				\item 初始化：设置 sstatus 的使能中断 SIE 位  \pause
				\item 初始化：实现中断服务总控函数 \pause
				\item 初始化：设置 stvec指向中断服务总控函数的入口地址
				
			\end{itemize}
			
		\end{column}
		
	\end{columns}
	
\end{frame}



%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--保存恢复现场}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
			%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
			
			\includegraphics[width=.3\linewidth]{timer}
			%show rcore tutorial	
			
			\begin{itemize} \small 
				\item 还需为被中断的程序保存和恢复当时程序运行时的上下文：\pause
				\item SAVE\_ALL  \pause 寄存器 \pause
				
			\end{itemize}
			
		\end{column}
		
	\end{columns}
	
\end{frame}



%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--保存恢复现场}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
			%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
			
			\includegraphics[width=.2\linewidth]{timer}
			%show rcore tutorial	
			
			\begin{itemize} \small 
				\item 要保存和恢复当时程序运行时的上下文：\pause
				\item x[0--32]：通用寄存器 \pause
				\item sstatus：系统系状态
				\item sepc：触发异常/中断的指令地址
				\item scause：指示发生异常/中断的种类
				\item stval：保存了发生异常/中断的附加信息
				%show code
			\end{itemize}
			
		\end{column}
		
	\end{columns}
	
\end{frame}


%------------------------------------------------
%\begin{frame}[plain,t]
%	\frametitle{中断处理机制--保存恢复现场}
%	%	\framesubtitle{xxxx}
%	\begin{columns}
%		
%		\begin{column}{0.4\textwidth}
%			\centering
%			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
%			\begin{itemize} \small
%				\item Core Local	Interruptor (CLINT)
%				\item Platform-Level Interrupt Controller (PLIC)
%			\end{itemize}
%			
%		\end{column}
%		
%		\begin{column}{0.5\textwidth}
%			
%			\centering
%			%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
%			
%			\includegraphics[width=.3\linewidth]{timer}
%			%show rcore tutorial	
%			产生异常/中断时
%			\begin{itemize} \small 
%				\item sstatus：系统系状态
%				\item sepc：触发异常/中断的指令地址
%				\item scause：指示发生异常/中断的种类
%				\item stval：保存了发生异常/中断的附加信息
%				%show code
%			\end{itemize}
%
%	\end{column}
%	
%	\end{columns}
%
%\end{frame}				
%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--还原整个过程}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
			%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
%			\includegraphics[width=.2\linewidth]{timer}
			%show rcore tutorial	
			产生中断后：
			\begin{itemize} \small 
				\item 硬件设置：\pause
				\begin{itemize} \small 
					\item sepc：保存中断的指令地址	
					\item pc：设置为 stvec
					\item scause：设置中断的来源
					\item sstatus：SIE位置零以禁用中断					
					\item stval：保存了中断相关的附加信息
			   \end{itemize}	
				\item 软件保存：\pause
				\begin{itemize} \small 
					\item x[0--32]：通用寄存器 	
					\item pc：设置为 stvec
					\item scause：设置中断的来源
					\item sstatus：SIE位置零以禁用中断					
					\item stval：保存了中断相关的附加信息
				\end{itemize}											
%				show code
			\end{itemize}
			
		\end{column}
		
	\end{columns}
	
\end{frame}	

%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断处理机制--还原整个过程}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
			%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
			%			\includegraphics[width=.2\linewidth]{timer}
			%show rcore tutorial	
			产生中断后：
			\begin{itemize} \small 
				\item 硬件设置
%				\begin{itemize} \small 
%					\item sepc：保存中断的指令地址	
%					\item pc：设置为 stvec
%					\item scause：设置中断的来源
%					\item sstatus：SIE位置零以禁用中断					
%					\item stval：保存了中断相关的附加信息
%				\end{itemize}	
				\item 软件保存被打断现场\pause
%				\begin{itemize} \small 
%					\item x[0--32]：通用寄存器 	
%					\item pc：设置为 stvec
%					\item scause：设置中断的来源
%					\item sstatus：SIE位置零以禁用中断					
%					\item stval：保存了中断相关的附加信息
%				\end{itemize}											
				\item 执行软件实现的中断服务例程
				\item 软件恢复被打断现场
				\item 继续执行
				
			\end{itemize}
			
		\end{column}
		
	\end{columns}
	
\end{frame}	


%------------------------------------------------
\begin{frame}[plain,t]
	\frametitle{中断嵌套}
	%	\framesubtitle{xxxx}
	\begin{columns}
		
		\begin{column}{0.4\textwidth}
			\centering
			\includegraphics[width=1.0\linewidth]{os-4-intr-syscall-except}
			\begin{itemize} \small
				\item Core Local	Interruptor (CLINT)
				\item Platform-Level Interrupt Controller (PLIC)
			\end{itemize}
			
		\end{column}
		
		\begin{column}{0.5\textwidth}
			
			\centering
			%			\includegraphics[width=.6\linewidth]{fu540-intr-arch}	
			%			\includegraphics[width=.2\linewidth]{timer}
			%show rcore tutorial	
			
			\begin{itemize} \small 
				\item 硬件中断服务例程可被打断	
				\begin{itemize} \small										
					\item 不同硬件中断源可能在硬件中断处理时出现
					\item 中断请求会保持到CPU做出响应
					\item 硬件中断服务例程中需要临时禁止中断请求
				\end{itemize}
			\end{itemize}
			
		\end{column}
		
	\end{columns}
	
\end{frame}	
%----------------------------------------------------------------------------------------

\end{document}
